# 网络是怎样连接的

## 第一章 浏览器生成消息

### 1.1 生成HTTP请求消息

**输入网址**

URL：Uniform Resource Locator，统一资源定位符。

实际上除了“http:”，网址还可以以其他一些文字开头，例如“ftp:”“file:”“mailto:”等

![image-20220313103048931](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220313103048931.png)



![image-20220313103136670](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220313103136670.png)

**解析URL**

![image-20220313103245071](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220313103245071.png)![image-20220313103352020](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220313103352020.png)

![image-20220313103428289](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220313103428289.png)

![image-20220313103453056](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220313103453056.png)![image-20220313103547642](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220313103547642.png)![image-20220313103738395](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220313103738395.png)

响应消息的格式以及基本思路和请求消息是相同的，差别只在第一行上。在响应消息中，第一行的内容为状态码和响应短语，用来表示请求的执行结果是成功还是出错。状态码和响应短语表示的内容一致，但它们的用途不同。状态码是一个数字，它主要用来向程序告知执行的结果；相对地，响应短语则是一段文字，用来向人们告知执行的结果

![image-20220313104143724](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220313104143724.png)

![image-20220313104327959](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220313104327959.png)![image-20220313104450325](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220313104450325.png)

### 1.2 向 **DNS** 服务器查询 **Web** 服务器的 **IP** 地址

生成 HTTP 消息之后，接下来我们需要委托操作系统将消息发送给 Web 服务器。尽管浏览器能够解析网址并生成 HTTP 消息，但它本身并不具备将消息发送到网络中的功能，因此这一功能需要委托操作系统来实现 。在进行这一操作时，我们还有一个工作需要完成，那就是查询网址中服务器域名对应的 IP 地址。在委托操作系统发送消息时，必须要提供的不是通信对象的域名，而是它的 IP 地址。因此，在生成 HTTP 消息 之后，下一个步骤就是根据域名查询 IP 地址。

![image-20220313104858322](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220313104858322.png)

实际的 IP 地址是一串 32 比特的数字，按照 8 比特（1 字节）为一组分成 4 组，分别用十进制表示然后再用圆点隔开。这就是我们平常经常见到的 IP 地址格式，但仅凭这一串数字我们无法区分哪部分 是网络号，哪部分是主机号。在 IP 地址的规则中，网络号和主机号连起来总共是 32 比特，但这两部分的具 体结构是不固定的

![image-20220313105151657](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220313105151657.png)![image-20220313105346739](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220313105346739.png)

向 DNS 服务器发出查询，也就是向 DNS 服务器发送查询消息，并接收服务器返回的响应消息。换句话说对于 DNS 服务器，我们的计算机一定有相应的 DNS 客户端，而相当于 DNS 客户端的部分称为 DNS 解析 器，或者简称解析器。通过 DNS 查询 IP 地址的操作称为域名解析，因此负责执行解析（resolution）这一操 作的就叫解析器（resolver）了。Socket 库也是一种库，其中包含的程序组件可以让其他的应用程序调 用操作系统的网络功能，而解析器就是这个库中的其中一种程序组件

![image-20220313105733823](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220313105733823.png)

调用解析器后，解析器会向 DNS 服务器发送查询消息，然后 DNS 服务器会返回响应消息。响应消息中包含查询到的 IP 地址，解析器会取出 IP 地址，并将其写入浏览器指定的内存地址中。只要运行图 1.11 中的这一 行程序，就可以完成前面所有这些工作，我们也就完成了 IP 地址的查询。接下来，浏览器在向 Web 服务器 发送消息时，只要从该内存地址取出 IP 地址，并将它与 HTTP 请求消息一起交给操作系统就可以了。

![image-20220313110016845](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220313110016845.png)一

应用程序编写的操作内容是从上往下按顺序执行的，当到达需要调用解析器的部分时，对应的那 一行程序就会被执行，应用程序本身的工作就会暂停（图 1.12 ①）。然后，Socket 库中的解析器开始运行图 1.12 ②），完成应用程序委托的操作。像这样，由于调用了其他程序，原本运行的程序进入暂停状 态，而被调用的程序开始运行，这就是“控制流程转移”。解析器调用协议栈后，控制流程会再次转移，协议栈会执行发 送消息的操作，然后通过网卡将消息发送给 DNS 服务器。

HTTP 消息是用文本编写的，但 DNS 消息是使用二进制数据编写的。协议栈：操作系统内部的网络控制软件，也叫“协议驱动”“TCP/IP 驱动”等。向 DNS 服务器发送消息时，我们当然也需要知道 DNS 服务器的 IP 地址。只不过这个 IP 地址是 作为 TCP/IP 的一个设置项目事先设置好的，不需要再去查询了。不同的操作系统中 TCP/IP 的设置方法也有 差异，Windows 中的设置如图 1.13 所示，解析器会根据这里设置的 DNS 服务器 IP 地址来发送消息。

### 1.3 全世界 **DNS** 服务器的大接力

其中，来自客户端的查询消息包含以下 3 种信息。 

（a）域名

服务器、邮件服务器（邮件地址中 @ 后面的部分）的名称 

（b）Class 

在最早设计 DNS 方案时，DNS 在互联网以外的其他网络中的应用也被考虑到了，而 Class 就是用来识别网络的信息。不过，如今除了互联网并没有其他的网络了，因此 Class 的值永远是代表互联网的 IN 

（c）记录类型

表示域名对应何种类型的记录。例如，当类型为 A 时，表示域名对应的是 IP 地址；当类型为 MX 时，表示域名对应的是邮件服务器。对于不同的记录类型，服务器向客户端返回的信息也会不同

首先，将负责管 理下级域的 DNS 服务器的 IP 地址注册到它们的上级 DNS 服务器中，然后上级 DNS 服务器的 IP 地址再注 册到更上一级的 DNS 服务器中，以此类推。也就是说，负责管理 lab.glasscom.com 这个域的 DNS 服务器的 IP 地址需要注册到 glasscom.com 域的 DNS 服务器中，而 glasscom.com 域的 DNS 服务器的 IP 地址又需要注 册到 com 域的 DNS 服务器中。这样，我们就可以通过上级 DNS 服务器查询出下级 DNS 服务器的 IP 地 址，也就可以向下级 DNS 服务器发送查询请求了。

![image-20220313111937725](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220313111937725.png)![image-20220313112025281](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220313112025281.png)

因为 DNS 服务器有一个缓存功能，可以记住之前查询过的域名。如果要查询的域名和相关信息已经在缓存中，那么就可以直接返回响应，接下来的查询可以从缓 存的位置开始向下进行。相比每次都从根域找起来说，缓存可以减少查询所需的时间。这个缓存机制中有一点需要注意，那就是信息被缓存后，原本的注册信息可能会发生改变，这时缓存中的信 息就有可能是不正确的。因此，DNS 服务器中保存的信息都设置有一个有效期，当缓存中的信息超过有效 期后，数据就会从缓存中删除。而且，在对查询进行响应时，DNS 服务器也会告知客户端这一响应的结果 是来自缓存中还是来自负责管理该域名的 DNS 服务器.

知道了 IP 地址之后，就可以委托操作系统内部的协议栈向这个目标 IP 地址，也就是我们要访问的 Web 服 务器发送消息了。要发送给 Web 服务器的 HTTP 消息是一种数字信息（digital data），因此也可以说是委托 协议栈来发送数字信息。收发数字信息这一操作不仅限于浏览器，对于各种使用网络的应用程序来说都是共 通的。因此，这一操作的过程也不仅适用于 Web，而是适用于任何网络应用程序。

向操作系统内部的协议栈发出委托时，需要按照指定的顺序来调用 **Socket** 库中的程序组件。 使用 Socket 库来收发数据的操作过程如图 1.17 所示  。简单来说，收发数据的两台计算机之间连接了一条 数据通道，数据沿着这条通道流动，最终到达目的地。我们可以把数据通道想象成一条管道，将数据从一端 送入管道，数据就会到达管道的另一端然后被取出。数据可以从任何一端被送入管道，数据的流动是双向。我们需要先创建套接字，然后再将套接字连接起来形成管道。实际的 

过程是下面这样的。首先，服务器一方先创建套接字，然后等待客户端向该套接字连接管道  。当服务器 进入等待状态时，客户端就可以连接管道了。具体来说，客户端也会先创建一个套接字，然后从该套接字延 伸出管道，最后管道连接到服务器端的套接字上。当双方的套接字连接起来之后，通信准备就完成了。接下 来，就像我们刚刚讲过的一样，只要将数据送入套接字就可以收发数据了

我们再来看一看收发数据操作结束时的情形。当数据全部发送完毕之后，连接的管道将会被断开。管道在连 接时是由客户端发起的，但在断开时可以由客户端或服务器任意一方发起 。其中一方断开后，另一方也 会随之断开，当管道断开后，套接字也会被删除。到此为止，通信操作就结束了。综上所述，收发数据的操 作分为若干个阶段，可以大致总结为以下 4 个![image-20220313112501000](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220313112501000.png)![image-20220313112603942](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220313112603942.png)

套接字创建完成后，协议栈会返回一个描述符，应用程序会将收到的描述符存放在内存中。描述符是用来识 别不同的套接字的，

接下来，我们需要委托协议栈将客户端创建的套接字与服务器那边的套接字连接起来。应用程序通过调用 Socket 库中的名为 connect 的程序组件来完成这一操作。这里的要点是当调用 connect 时，需要指定描述符、服务器 IP 地址和端口号这 3 个参数。首先，客户端在创建套接字时，协议栈会为这个套 接字随便分配一个端口号。接下来，当协议栈执行连接操作时，会将这个随便分配的端口号通知给服务 器

Web 使用的 HTTP 协议规定，当 Web 服务器发送完响应消息之后，应该主动执行断开操作，因此 Web 服务器会首先调用 close 来断开连接。断开操作传达到客户端之后，客户端的套接字也会 进入断开阶段。接下来，当浏览器调用 read 执行接收数据操作时，read 会告知浏览器收发数据操作已结束，连接已经断开。浏览器得知后，也会调用 close 进入断开阶段。因此，如果一个网页中包含很多张图片， 就必须重复进行很多次连接、收发数据、断开的操作。对于同一台服务器来说，重复连接和断开显然是效率 很低的，因此后来人们又设计出了能够在一次连接中收发多个请求和响应的方法。在 HTTP 版本 1.1 中就可以使用这种方法，在这种情况下，当所有数据都请求完成后，浏览器会主动触发断开连接的操作

## 第二章 TCP/IP-探索协议栈和网卡

### 2.1 创建套接字

![image-20220313114759222](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220313114759222.png)

像浏览器、邮件等一般的应用程序都是使用 TCP 收发数据的，而像 DNS 查询等收发较短的控制数据的时候则使用 UDP。

下面一半是用 IP 协议控制网络包收发操作的部分。在互联网上传送数据时，数据会被切分成一个一个的网 络包 ，而将网络包发送给通信对象的操作就是由 IP 来负责的。此外，IP 中还包括 ICMP协议和 ARP协议。 ICMP 用于告知网络包传送过程中产生的错误以及各种控制消息，ARP 用于根据 IP 地址查询相应的以太网 MAC 地址。IP 下面的网卡驱动程序负责控制网卡硬件，而最下面的网卡则负责完成实际的收发操作，也就是对网线中 的信号执行发送和接收的操作。

![image-20220313151650660](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220313151650660.png)

# 计算机网络微课堂

## 第一章 概述

### 1.1 因特网概述

1、网络互联网和因特网

网络由若干结点和连接节点的链路组成，多个网络由路由器互连起来称为互联网，internet与Internet

![image-20220330211405622](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220330211405622.png)

三级结构网络：NSFNET（主干网、地区网和校园网）ISP:互联网服务提供商

![image-20220330211743917](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220330211743917.png)

### 1.2 三种交换方式：电路交换、分组交换和报文交换

![image-20220405155903584](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220405155903584.png)

### 1.3 计算机网络的定义和分类

![image-20220405160027134](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220405160027134.png)



![image-20220405160124904](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220405160124904.png)



### 1.4 计算机网络的性能指标

![](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220405160313818.png)![image-20220405160521918](C:\Users\001\AppData\Roaming\Typora\typora-user-images\image-20220405160521918.png)
